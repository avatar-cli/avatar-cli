---
stages:
  - boilerplate_checks
  - test
  - publish

boilerplate_checks:
  stage: boilerplate_checks
  image: 'node:14-buster'
  except:
    refs:
      - dev
      - main
  script:
    - 'cd "${CI_PROJECT_DIR}/cx"'
    - 'npm install'
    - 'npm run lint'
    - './node_modules/.bin/ts-node ./src/scripts/git_checks.ts'

test:
  stage: test
  image: 'rust:1.45-stretch'
  except:
    refs:
      - dev
      - main
  script:
    - rustup component add clippy
    - cargo clippy

crates_publish:
  stage: publish
  image: 'rust:1.45-stretch'
  only:
    refs:
      - main
  variables:
    CARGO_TOKEN: $CARGO_TOKEN
  script:
    - cargo login ${CARGO_TOKEN}
    - cargo publish --no-verify

include:
  # See https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
  # See https://gitlab.com/gitlab-org/gitlab-foss/blob/master/lib/gitlab/ci/templates/Security/SAST.gitlab-ci.yml
  - template: SAST.gitlab-ci.yml
